name: Build and Push to ECR

on:
  push:
    branches:
      - main
    paths:
      - 'video-analytics/**'
      - '.github/workflows/build-push.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 385046010615.dkr.ecr.us-east-1.amazonaws.com
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # Detect which services changed
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      analytics: ${{ steps.changes.outputs.analytics }}
      auth: ${{ steps.changes.outputs.auth }}
      gateway: ${{ steps.changes.outputs.gateway }}
      processor: ${{ steps.changes.outputs.processor }}
      uploader: ${{ steps.changes.outputs.uploader }}
      frontend: ${{ steps.changes.outputs.frontend }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for changes
        id: changes
        run: |
          # Check each service for changes
          if git diff HEAD^ HEAD --name-only | grep -q "video-analytics/backend/analytics/"; then
            echo "analytics=true" >> $GITHUB_OUTPUT
          else
            echo "analytics=false" >> $GITHUB_OUTPUT
          fi
          
          if git diff HEAD^ HEAD --name-only | grep -q "video-analytics/backend/auth/"; then
            echo "auth=true" >> $GITHUB_OUTPUT
          else
            echo "auth=false" >> $GITHUB_OUTPUT
          fi
          
          if git diff HEAD^ HEAD --name-only | grep -q "video-analytics/backend/gateway/"; then
            echo "gateway=true" >> $GITHUB_OUTPUT
          else
            echo "gateway=false" >> $GITHUB_OUTPUT
          fi
          
          if git diff HEAD^ HEAD --name-only | grep -q "video-analytics/backend/processor/"; then
            echo "processor=true" >> $GITHUB_OUTPUT
          else
            echo "processor=false" >> $GITHUB_OUTPUT
          fi
          
          if git diff HEAD^ HEAD --name-only | grep -q "video-analytics/backend/uploader/"; then
            echo "uploader=true" >> $GITHUB_OUTPUT
          else
            echo "uploader=false" >> $GITHUB_OUTPUT
          fi
          
          if git diff HEAD^ HEAD --name-only | grep -q "video-analytics/frontend/"; then
            echo "frontend=true" >> $GITHUB_OUTPUT
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi

  # Build and push analytics service
  build-analytics:
    name: Build Analytics Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.analytics == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::385046010615:role/github-actions-ecr-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        working-directory: video-analytics/backend/analytics
        run: |
          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_URI="${{ env.ECR_REGISTRY }}/analytics-service:${IMAGE_TAG}"
          IMAGE_LATEST="${{ env.ECR_REGISTRY }}/analytics-service:latest"
          
          docker build --platform linux/amd64 -t ${IMAGE_URI} -t ${IMAGE_LATEST} .
          docker push ${IMAGE_URI}
          docker push ${IMAGE_LATEST}
          
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV

      - name: Run Trivy scan on pushed image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.IMAGE_URI }}'
          format: 'table'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Generate Trivy JSON report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.IMAGE_URI }}'
          format: 'json'
          output: 'trivy-analytics-report.json'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Generate Trivy HTML report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.IMAGE_URI }}'
          format: 'template'
          template: '@/contrib/html.tpl'
          output: 'trivy-analytics-report.html'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Upload Trivy scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-analytics-reports
          path: |
            trivy-analytics-report.json
            trivy-analytics-report.html
          retention-days: 30

      - name: Save image tag for deployment
        run: |
          echo "${{ env.IMAGE_TAG }}" > analytics-image-tag.txt

      - name: Upload image tag artifact
        uses: actions/upload-artifact@v4
        with:
          name: analytics-image-tag
          path: analytics-image-tag.txt
          retention-days: 7

  # Build and push auth service
  build-auth:
    name: Build Auth Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.auth == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::385046010615:role/github-actions-ecr-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        working-directory: video-analytics/backend/auth
        run: |
          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_URI="${{ env.ECR_REGISTRY }}/auth-service:${IMAGE_TAG}"
          IMAGE_LATEST="${{ env.ECR_REGISTRY }}/auth-service:latest"
          
          docker build --platform linux/amd64 -t ${IMAGE_URI} -t ${IMAGE_LATEST} .
          docker push ${IMAGE_URI}
          docker push ${IMAGE_LATEST}

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/auth-service:${{ github.sha }}'
          format: 'table'
          severity: 'HIGH,CRITICAL'

      - name: Generate Trivy JSON report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/auth-service:${{ github.sha }}'
          format: 'json'
          output: 'trivy-auth-report.json'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Generate Trivy HTML report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/auth-service:${{ github.sha }}'
          format: 'template'
          template: '@/contrib/html.tpl'
          output: 'trivy-auth-report.html'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Upload Trivy scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-auth-reports
          path: |
            trivy-auth-report.json
            trivy-auth-report.html
          retention-days: 30

  # Build and push gateway service
  build-gateway:
    name: Build Gateway Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.gateway == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::385046010615:role/github-actions-ecr-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        working-directory: video-analytics/backend/gateway
        run: |
          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_URI="${{ env.ECR_REGISTRY }}/gateway-service:${IMAGE_TAG}"
          IMAGE_LATEST="${{ env.ECR_REGISTRY }}/gateway-service:latest"
          
          docker build --platform linux/amd64 -t ${IMAGE_URI} -t ${IMAGE_LATEST} .
          docker push ${IMAGE_URI}
          docker push ${IMAGE_LATEST}

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/gateway-service:latest'
          format: 'table'
          severity: 'HIGH,CRITICAL'

      - name: Generate Trivy JSON report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/gateway-service:latest'
          format: 'json'
          output: 'trivy-gateway-report.json'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Generate Trivy HTML report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/gateway-service:latest'
          format: 'template'
          template: '@/contrib/html.tpl'
          output: 'trivy-gateway-report.html'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Upload Trivy scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-gateway-reports
          path: |
            trivy-gateway-report.json
            trivy-gateway-report.html
          retention-days: 30

  # Build and push processor service
  build-processor:
    name: Build Processor Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.processor == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::385046010615:role/github-actions-ecr-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        working-directory: video-analytics/backend/processor
        run: |
          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_URI="${{ env.ECR_REGISTRY }}/processor-service:${IMAGE_TAG}"
          IMAGE_LATEST="${{ env.ECR_REGISTRY }}/processor-service:latest"
          
          docker build --platform linux/amd64 -t ${IMAGE_URI} -t ${IMAGE_LATEST} .
          docker push ${IMAGE_URI}
          docker push ${IMAGE_LATEST}

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/processor-service:latest'
          format: 'table'
          severity: 'HIGH,CRITICAL'

      - name: Generate Trivy JSON report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/processor-service:latest'
          format: 'json'
          output: 'trivy-processor-report.json'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Generate Trivy HTML report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/processor-service:latest'
          format: 'template'
          template: '@/contrib/html.tpl'
          output: 'trivy-processor-report.html'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Upload Trivy scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-processor-reports
          path: |
            trivy-processor-report.json
            trivy-processor-report.html
          retention-days: 30

  # Build and push uploader service
  build-uploader:
    name: Build Uploader Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.uploader == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::385046010615:role/github-actions-ecr-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        working-directory: video-analytics/backend/uploader
        run: |
          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_URI="${{ env.ECR_REGISTRY }}/uploader-service:${IMAGE_TAG}"
          IMAGE_LATEST="${{ env.ECR_REGISTRY }}/uploader-service:latest"
          
          docker build --platform linux/amd64 -t ${IMAGE_URI} -t ${IMAGE_LATEST} .
          docker push ${IMAGE_URI}
          docker push ${IMAGE_LATEST}

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/uploader-service:latest'
          format: 'table'
          severity: 'HIGH,CRITICAL'

      - name: Generate Trivy JSON report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/uploader-service:latest'
          format: 'json'
          output: 'trivy-uploader-report.json'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Generate Trivy HTML report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/uploader-service:latest'
          format: 'template'
          template: '@/contrib/html.tpl'
          output: 'trivy-uploader-report.html'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Upload Trivy scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-uploader-reports
          path: |
            trivy-uploader-report.json
            trivy-uploader-report.html
          retention-days: 30

  # Build and push frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::385046010615:role/github-actions-ecr-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        working-directory: video-analytics/frontend
        run: |
          IMAGE_TAG="${GITHUB_SHA:0:7}"
          IMAGE_URI="${{ env.ECR_REGISTRY }}/frontend:${IMAGE_TAG}"
          IMAGE_LATEST="${{ env.ECR_REGISTRY }}/frontend:latest"
          
          docker build --platform linux/amd64 -t ${IMAGE_URI} -t ${IMAGE_LATEST} .
          docker push ${IMAGE_URI}
          docker push ${IMAGE_LATEST}

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/frontend:latest'
          format: 'table'
          severity: 'HIGH,CRITICAL'

      - name: Generate Trivy JSON report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/frontend:latest'
          format: 'json'
          output: 'trivy-frontend-report.json'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Generate Trivy HTML report
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/frontend:latest'
          format: 'template'
          template: '@/contrib/html.tpl'
          output: 'trivy-frontend-report.html'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Upload Trivy scan reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-frontend-reports
          path: |
            trivy-frontend-report.json
            trivy-frontend-report.html
          retention-days: 30

  # Trigger deployment workflow
  trigger-deployment:
    name: Trigger EKS Deployment
    runs-on: ubuntu-latest
    needs: [build-analytics, build-auth, build-gateway, build-processor, build-uploader, build-frontend]
    if: always() && (needs.build-analytics.result == 'success' || needs.build-auth.result == 'success' || needs.build-gateway.result == 'success' || needs.build-processor.result == 'success' || needs.build-uploader.result == 'success' || needs.build-frontend.result == 'success')
    
    steps:
      - name: Trigger deployment workflow
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-eks.yml',
              ref: 'main',
              inputs: {
                environment: '${{ github.event.inputs.environment || 'dev' }}',
                image_tag: '${{ github.sha }}'
              }
            })
