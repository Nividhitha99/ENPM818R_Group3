name: Build and Deploy

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: video-analytics
  EKS_CLUSTER_NAME: video-analytics-cluster

permissions:
  id-token: write # For OIDC
  contents: read

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Run Trivy vulnerability scanner in repo mode
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        ignore-unfixed: true
        format: 'table'
        severity: 'CRITICAL,HIGH'

  build-and-push:
    needs: security-scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    strategy:
      matrix:
        service: [uploader, processor, analytics, frontend]
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: arn:aws:iam::ACCOUNT_ID:role/github-actions-role
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Build, tag, and push image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        cd backend/${{ matrix.service }} || cd ${{ matrix.service }} # logic adjustment needed for frontend
        if [ "${{ matrix.service }}" == "frontend" ]; then cd ../../frontend; fi
        
        docker build -t $ECR_REGISTRY/${{ matrix.service }}:$IMAGE_TAG .
        docker push $ECR_REGISTRY/${{ matrix.service }}:$IMAGE_TAG
        
        # Also push latest
        docker tag $ECR_REGISTRY/${{ matrix.service }}:$IMAGE_TAG $ECR_REGISTRY/${{ matrix.service }}:latest
        docker push $ECR_REGISTRY/${{ matrix.service }}:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: arn:aws:iam::ACCOUNT_ID:role/github-actions-role
        aws-region: ${{ env.AWS_REGION }}

    - name: Update Kubeconfig
      run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

    - name: Deploy to EKS
      run: |
        # Replace placeholders (in real life use Helm or Kustomize)
        sed -i "s|123456789012.dkr.ecr.us-east-1.amazonaws.com/uploader:latest|${{ steps.login-ecr.outputs.registry }}/uploader:${{ github.sha }}|g" k8s/prod/uploader.yaml
        # ... repeat for others
        kubectl apply -f k8s/prod/

